import{j as o,r as l,u as We,a as P,c as fe,C as Te,b as Ie,R as Ge}from"./r3f-OPPjv2-t.js";import{c as oe}from"./three-DtmJfnfJ.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}})();const C={groundWidth:80,groundDepth:80,treeCount:80,clearRadius:12,treeCollisionRadius:.8,groundColor:"#3a7d2c",skyColor:"#87CEEB"};function O(e){const t=Math.sin(e*9301+49297)*233280;return t-Math.floor(t)}function Le(e,t){const n=[],r=C.groundWidth/2-2,s=C.groundDepth/2-2,i=2.5;let a=0;for(;n.length<e&&a<e*20;){const c=O(a++)*r*2-r,u=O(a++)*s*2-s;if(Math.sqrt(c*c+u*u)<t)continue;let x=!1;for(const g of n){const p=c-g.x,w=u-g.z;if(p*p+w*w<i*i){x=!0;break}}x||n.push({x:c,z:u})}return n}function He(e){const n=1+O(e)*3,r=.15+O(e+100)*.15,s=.8+O(e+200)*1.2,i=O(e+300)>.5?"cone":"sphere";return{trunkHeight:n,trunkRadius:r,canopyRadius:s,canopyType:i}}let Q=null;function Ae(){return Q||(Q=Le(C.treeCount,C.clearRadius)),Q}function Be(e,t,n){const r=Ae(),s=C.treeCollisionRadius+n;let i=e,a=t,c=!1;for(const u of r){const f=i-u.x,x=a-u.z,g=f*f+x*x;if(g<s*s&&g>0){const p=Math.sqrt(g),w=s-p,m=f/p,_=x/p;i+=m*w,a+=_*w,c=!0}}return{x:i,z:a,collided:c}}function Ue(){return o.jsxs("mesh",{rotation:[-Math.PI/2,0,0],position:[0,0,0],receiveShadow:!0,children:[o.jsx("planeGeometry",{args:[C.groundWidth,C.groundDepth]}),o.jsx("meshToonMaterial",{color:C.groundColor})]})}const xe=["#2E7D32","#388E3C","#43A047","#4CAF50","#66BB6A"],Ke="#8B4513";function qe({x:e,z:t,seed:n}){const r=l.useMemo(()=>He(n),[n]),s=xe[n%xe.length],i=r.trunkHeight+r.canopyRadius*.6;return o.jsxs("group",{position:[e,0,t],children:[o.jsxs("mesh",{position:[0,r.trunkHeight/2,0],castShadow:!0,children:[o.jsx("cylinderGeometry",{args:[r.trunkRadius,r.trunkRadius*1.3,r.trunkHeight,6]}),o.jsx("meshToonMaterial",{color:Ke})]}),o.jsxs("mesh",{position:[0,i,0],castShadow:!0,children:[r.canopyType==="sphere"?o.jsx("sphereGeometry",{args:[r.canopyRadius,8,6]}):o.jsx("coneGeometry",{args:[r.canopyRadius,r.canopyRadius*2,6]}),o.jsx("meshToonMaterial",{color:s})]})]})}function Ye(){const e=l.useMemo(()=>Ae().map((n,r)=>({...n,seed:r,key:`tree-${r}`})),[]);return o.jsx("group",{children:e.map(t=>o.jsx(qe,{x:t.x,z:t.z,seed:t.seed},t.key))})}function $e(){return o.jsxs(o.Fragment,{children:[o.jsx("ambientLight",{intensity:.5,color:"#FFF8E1"}),o.jsx("directionalLight",{position:[15,20,10],intensity:1.2,castShadow:!0,"shadow-mapSize-width":2048,"shadow-mapSize-height":2048,"shadow-camera-left":-40,"shadow-camera-right":40,"shadow-camera-top":40,"shadow-camera-bottom":-40,"shadow-camera-near":.1,"shadow-camera-far":80})]})}function Ze(){return o.jsxs(o.Fragment,{children:[o.jsx("color",{attach:"background",args:[C.skyColor]}),o.jsx("fog",{attach:"fog",args:[C.skyColor,30,60]}),o.jsx($e,{}),o.jsx(Ue,{}),o.jsx(Ye,{})]})}function Xe(){const e=l.useRef({w:!1,a:!1,s:!1,d:!1});return l.useEffect(()=>{const t=r=>{switch(r.code){case"KeyW":case"ArrowUp":e.current.w=!0;break;case"KeyA":case"ArrowLeft":e.current.a=!0;break;case"KeyS":case"ArrowDown":e.current.s=!0;break;case"KeyD":case"ArrowRight":e.current.d=!0;break}},n=r=>{switch(r.code){case"KeyW":case"ArrowUp":e.current.w=!1;break;case"KeyA":case"ArrowLeft":e.current.a=!1;break;case"KeyS":case"ArrowDown":e.current.s=!1;break;case"KeyD":case"ArrowRight":e.current.d=!1;break}};return window.addEventListener("keydown",t),window.addEventListener("keyup",n),()=>{window.removeEventListener("keydown",t),window.removeEventListener("keyup",n)}},[]),e}const Ve=new oe(0,8,12),Je=.08;function Qe(e){const{camera:t}=We(),n=l.useRef(new oe),r=l.useRef(new oe);P(()=>{e.current&&(e.current.getWorldPosition(n.current),r.current.copy(n.current).add(Ve),t.position.lerp(r.current,Je),t.lookAt(n.current))})}const Me={zombie_green:{health:30,speed:1.5,damage:2,attackSpeed:.7,coinDrop:[5,10],color:"#4CAF50"}},$={bat:{type:"bat",cost:0,damage:10,attackSpeed:2,range:2.5,isRanged:!1,unlockedAtPhase:0},spiked_bat:{type:"spiked_bat",cost:100,damage:20,attackSpeed:2,range:2.5,isRanged:!1,unlockedAtPhase:0},crossbow:{type:"crossbow",cost:300,damage:30,attackSpeed:1,range:20,isRanged:!0,projectileSpeed:15,unlockedAtPhase:0},shotgun:{type:"shotgun",cost:800,damage:50,attackSpeed:.8,range:10,isRanged:!0,projectileSpeed:25,aoeRadius:3,unlockedAtPhase:0},rifle:{type:"rifle",cost:1500,damage:40,attackSpeed:3,range:40,isRanged:!0,projectileSpeed:40,unlockedAtPhase:0},minigun:{type:"minigun",cost:3e3,damage:15,attackSpeed:10,range:25,isRanged:!0,projectileSpeed:30,unlockedAtPhase:0},rocket_launcher:{type:"rocket_launcher",cost:5e3,damage:150,attackSpeed:.5,range:30,isRanged:!0,projectileSpeed:12,aoeRadius:5,unlockedAtPhase:0},silver_sword:{type:"silver_sword",cost:2e3,damage:60,attackSpeed:3,range:3,isRanged:!1,unlockedAtPhase:1},holy_crossbow:{type:"holy_crossbow",cost:4e3,damage:80,attackSpeed:1.5,range:25,isRanged:!0,projectileSpeed:20,unlockedAtPhase:2},magic_staff:{type:"magic_staff",cost:8e3,damage:100,attackSpeed:2,range:30,isRanged:!0,projectileSpeed:18,aoeRadius:4,unlockedAtPhase:3}},se={health:100,speed:5},H=38;function et(e){let t=0,n=0;e.a&&(t-=1),e.d&&(t+=1),e.w&&(n-=1),e.s&&(n+=1);const r=Math.sqrt(t*t+n*n);return r===0?{x:0,z:0}:{x:t/r,z:n/r}}function tt(e,t,n){return{x:Math.max(-H,Math.min(H,e)),y:t,z:Math.max(-H,Math.min(H,n))}}function nt(e){return e.x===0&&e.z===0?null:Math.atan2(e.x,e.z)}const ge=se.speed;var Pe=Symbol.for("immer-nothing"),ye=Symbol.for("immer-draftable"),S=Symbol.for("immer-state");function R(e,...t){throw new Error(`[Immer] minified error nr: ${e}. Full error at: https://bit.ly/3cXEKWf`)}var T=Object.getPrototypeOf;function F(e){return!!e&&!!e[S]}function N(e){return e?Ee(e)||Array.isArray(e)||!!e[ye]||!!e.constructor?.[ye]||L(e)||X(e):!1}var rt=Object.prototype.constructor.toString(),we=new WeakMap;function Ee(e){if(!e||typeof e!="object")return!1;const t=Object.getPrototypeOf(e);if(t===null||t===Object.prototype)return!0;const n=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;if(n===Object)return!0;if(typeof n!="function")return!1;let r=we.get(n);return r===void 0&&(r=Function.toString.call(n),we.set(n,r)),r===rt}function K(e,t,n=!0){Z(e)===0?(n?Reflect.ownKeys(e):Object.keys(e)).forEach(s=>{t(s,e[s],e)}):e.forEach((r,s)=>t(s,r,e))}function Z(e){const t=e[S];return t?t.type_:Array.isArray(e)?1:L(e)?2:X(e)?3:0}function ie(e,t){return Z(e)===2?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function Ne(e,t,n){const r=Z(e);r===2?e.set(t,n):r===3?e.add(n):e[t]=n}function ot(e,t){return e===t?e!==0||1/e===1/t:e!==e&&t!==t}function L(e){return e instanceof Map}function X(e){return e instanceof Set}function E(e){return e.copy_||e.base_}function ae(e,t){if(L(e))return new Map(e);if(X(e))return new Set(e);if(Array.isArray(e))return Array.prototype.slice.call(e);const n=Ee(e);if(t===!0||t==="class_only"&&!n){const r=Object.getOwnPropertyDescriptors(e);delete r[S];let s=Reflect.ownKeys(r);for(let i=0;i<s.length;i++){const a=s[i],c=r[a];c.writable===!1&&(c.writable=!0,c.configurable=!0),(c.get||c.set)&&(r[a]={configurable:!0,writable:!0,enumerable:c.enumerable,value:e[a]})}return Object.create(T(e),r)}else{const r=T(e);if(r!==null&&n)return{...e};const s=Object.create(r);return Object.assign(s,e)}}function me(e,t=!1){return V(e)||F(e)||!N(e)||(Z(e)>1&&Object.defineProperties(e,{set:B,add:B,clear:B,delete:B}),Object.freeze(e),t&&Object.values(e).forEach(n=>me(n,!0))),e}function st(){R(2)}var B={value:st};function V(e){return e===null||typeof e!="object"?!0:Object.isFrozen(e)}var it={};function D(e){const t=it[e];return t||R(0,e),t}var I;function De(){return I}function at(e,t){return{drafts_:[],parent_:e,immer_:t,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function be(e,t){t&&(D("Patches"),e.patches_=[],e.inversePatches_=[],e.patchListener_=t)}function ce(e){ue(e),e.drafts_.forEach(ct),e.drafts_=null}function ue(e){e===I&&(I=e.parent_)}function je(e){return I=at(I,e)}function ct(e){const t=e[S];t.type_===0||t.type_===1?t.revoke_():t.revoked_=!0}function _e(e,t){t.unfinalizedDrafts_=t.drafts_.length;const n=t.drafts_[0];return e!==void 0&&e!==n?(n[S].modified_&&(ce(t),R(4)),N(e)&&(e=q(t,e),t.parent_||Y(t,e)),t.patches_&&D("Patches").generateReplacementPatches_(n[S].base_,e,t.patches_,t.inversePatches_)):e=q(t,n,[]),ce(t),t.patches_&&t.patchListener_(t.patches_,t.inversePatches_),e!==Pe?e:void 0}function q(e,t,n){if(V(t))return t;const r=e.immer_.shouldUseStrictIteration(),s=t[S];if(!s)return K(t,(i,a)=>ve(e,s,t,i,a,n),r),t;if(s.scope_!==e)return t;if(!s.modified_)return Y(e,s.base_,!0),s.base_;if(!s.finalized_){s.finalized_=!0,s.scope_.unfinalizedDrafts_--;const i=s.copy_;let a=i,c=!1;s.type_===3&&(a=new Set(i),i.clear(),c=!0),K(a,(u,f)=>ve(e,s,i,u,f,n,c),r),Y(e,i,!1),n&&e.patches_&&D("Patches").generatePatches_(s,n,e.patches_,e.inversePatches_)}return s.copy_}function ve(e,t,n,r,s,i,a){if(s==null||typeof s!="object"&&!a)return;const c=V(s);if(!(c&&!a)){if(F(s)){const u=i&&t&&t.type_!==3&&!ie(t.assigned_,r)?i.concat(r):void 0,f=q(e,s,u);if(Ne(n,r,f),F(f))e.canAutoFreeze_=!1;else return}else a&&n.add(s);if(N(s)&&!c){if(!e.immer_.autoFreeze_&&e.unfinalizedDrafts_<1||t&&t.base_&&t.base_[r]===s&&c)return;q(e,s),(!t||!t.scope_.parent_)&&typeof r!="symbol"&&(L(n)?n.has(r):Object.prototype.propertyIsEnumerable.call(n,r))&&Y(e,s)}}}function Y(e,t,n=!1){!e.parent_&&e.immer_.autoFreeze_&&e.canAutoFreeze_&&me(t,n)}function ut(e,t){const n=Array.isArray(e),r={type_:n?1:0,scope_:t?t.scope_:De(),modified_:!1,finalized_:!1,assigned_:{},parent_:t,base_:e,draft_:null,copy_:null,revoke_:null,isManual_:!1};let s=r,i=he;n&&(s=[r],i=G);const{revoke:a,proxy:c}=Proxy.revocable(s,i);return r.draft_=c,r.revoke_=a,c}var he={get(e,t){if(t===S)return e;const n=E(e);if(!ie(n,t))return lt(e,n,t);const r=n[t];return e.finalized_||!N(r)?r:r===ee(e.base_,t)?(te(e),e.copy_[t]=de(r,e)):r},has(e,t){return t in E(e)},ownKeys(e){return Reflect.ownKeys(E(e))},set(e,t,n){const r=Oe(E(e),t);if(r?.set)return r.set.call(e.draft_,n),!0;if(!e.modified_){const s=ee(E(e),t),i=s?.[S];if(i&&i.base_===n)return e.copy_[t]=n,e.assigned_[t]=!1,!0;if(ot(n,s)&&(n!==void 0||ie(e.base_,t)))return!0;te(e),le(e)}return e.copy_[t]===n&&(n!==void 0||t in e.copy_)||Number.isNaN(n)&&Number.isNaN(e.copy_[t])||(e.copy_[t]=n,e.assigned_[t]=!0),!0},deleteProperty(e,t){return ee(e.base_,t)!==void 0||t in e.base_?(e.assigned_[t]=!1,te(e),le(e)):delete e.assigned_[t],e.copy_&&delete e.copy_[t],!0},getOwnPropertyDescriptor(e,t){const n=E(e),r=Reflect.getOwnPropertyDescriptor(n,t);return r&&{writable:!0,configurable:e.type_!==1||t!=="length",enumerable:r.enumerable,value:n[t]}},defineProperty(){R(11)},getPrototypeOf(e){return T(e.base_)},setPrototypeOf(){R(12)}},G={};K(he,(e,t)=>{G[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}});G.deleteProperty=function(e,t){return G.set.call(this,e,t,void 0)};G.set=function(e,t,n){return he.set.call(this,e[0],t,n,e[0])};function ee(e,t){const n=e[S];return(n?E(n):e)[t]}function lt(e,t,n){const r=Oe(t,n);return r?"value"in r?r.value:r.get?.call(e.draft_):void 0}function Oe(e,t){if(!(t in e))return;let n=T(e);for(;n;){const r=Object.getOwnPropertyDescriptor(n,t);if(r)return r;n=T(n)}}function le(e){e.modified_||(e.modified_=!0,e.parent_&&le(e.parent_))}function te(e){e.copy_||(e.copy_=ae(e.base_,e.scope_.immer_.useStrictShallowCopy_))}var dt=class{constructor(e){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.useStrictIteration_=!0,this.produce=(t,n,r)=>{if(typeof t=="function"&&typeof n!="function"){const i=n;n=t;const a=this;return function(u=i,...f){return a.produce(u,x=>n.call(this,x,...f))}}typeof n!="function"&&R(6),r!==void 0&&typeof r!="function"&&R(7);let s;if(N(t)){const i=je(this),a=de(t,void 0);let c=!0;try{s=n(a),c=!1}finally{c?ce(i):ue(i)}return be(i,r),_e(s,i)}else if(!t||typeof t!="object"){if(s=n(t),s===void 0&&(s=t),s===Pe&&(s=void 0),this.autoFreeze_&&me(s,!0),r){const i=[],a=[];D("Patches").generateReplacementPatches_(t,s,i,a),r(i,a)}return s}else R(1,t)},this.produceWithPatches=(t,n)=>{if(typeof t=="function")return(a,...c)=>this.produceWithPatches(a,u=>t(u,...c));let r,s;return[this.produce(t,n,(a,c)=>{r=a,s=c}),r,s]},typeof e?.autoFreeze=="boolean"&&this.setAutoFreeze(e.autoFreeze),typeof e?.useStrictShallowCopy=="boolean"&&this.setUseStrictShallowCopy(e.useStrictShallowCopy),typeof e?.useStrictIteration=="boolean"&&this.setUseStrictIteration(e.useStrictIteration)}createDraft(e){N(e)||R(8),F(e)&&(e=ft(e));const t=je(this),n=de(e,void 0);return n[S].isManual_=!0,ue(t),n}finishDraft(e,t){const n=e&&e[S];(!n||!n.isManual_)&&R(9);const{scope_:r}=n;return be(r,t),_e(void 0,r)}setAutoFreeze(e){this.autoFreeze_=e}setUseStrictShallowCopy(e){this.useStrictShallowCopy_=e}setUseStrictIteration(e){this.useStrictIteration_=e}shouldUseStrictIteration(){return this.useStrictIteration_}applyPatches(e,t){let n;for(n=t.length-1;n>=0;n--){const s=t[n];if(s.path.length===0&&s.op==="replace"){e=s.value;break}}n>-1&&(t=t.slice(n+1));const r=D("Patches").applyPatches_;return F(e)?r(e,t):this.produce(e,s=>r(s,t))}};function de(e,t){const n=L(e)?D("MapSet").proxyMap_(e,t):X(e)?D("MapSet").proxySet_(e,t):ut(e,t);return(t?t.scope_:De()).drafts_.push(n),n}function ft(e){return F(e)||R(10,e),Fe(e)}function Fe(e){if(!N(e)||V(e))return e;const t=e[S];let n,r=!0;if(t){if(!t.modified_)return t.base_;t.finalized_=!0,n=ae(e,t.scope_.immer_.useStrictShallowCopy_),r=t.scope_.immer_.shouldUseStrictIteration()}else n=ae(e,!0);return K(n,(s,i)=>{Ne(n,s,Fe(i))},r),t&&(t.finalized_=!1),n}var mt=new dt,ht=mt.produce;const pt=e=>(t,n,r)=>(r.setState=(s,i,...a)=>{const c=typeof s=="function"?ht(s):s;return t(c,i,...a)},e(r.setState,n,r)),pe=pt,Se={phase:0,wave:0,playerHealth:se.health,playerMaxHealth:se.health,equippedWeapon:null,ownedWeapons:[],enemiesAlive:0,bossDefeated:!1,gameStarted:!1,gamePaused:!1,gameOver:!1,isVictory:!1,announcement:""},h=fe()(pe(e=>({...Se,startGame:()=>e(t=>{t.gameStarted=!0,t.wave=1}),addWeapon:t=>e(n=>{n.ownedWeapons.includes(t)||n.ownedWeapons.push(t)}),equipWeapon:t=>e(n=>{n.ownedWeapons.includes(t)&&(n.equippedWeapon=t)}),takeDamage:t=>e(n=>{n.playerHealth=Math.max(0,n.playerHealth-t),n.playerHealth===0&&(n.gameOver=!0)}),nextWave:()=>e(t=>{t.wave+=1}),setEnemiesAlive:t=>e(n=>{n.enemiesAlive=t}),setVictory:t=>e(n=>{n.isVictory=t}),setAnnouncement:t=>e(n=>{n.announcement=t}),resetGame:()=>e(()=>({...Se,ownedWeapons:[]}))}))),J=fe()(pe((e,t)=>({lastAttackTime:0,recentHits:[],canAttack:()=>{const n=t().getWeaponConfig();if(!n)return!1;const r=1e3/n.attackSpeed;return performance.now()-t().lastAttackTime>=r},performAttack:()=>{const n=t().getWeaponConfig();return n?(e(r=>{r.lastAttackTime=performance.now()}),n.damage):0},registerHit:(n,r)=>e(s=>{s.recentHits.push({enemyId:n,damage:r,timestamp:performance.now()})}),clearHits:()=>e(n=>{n.recentHits=[]}),getWeaponDamage:()=>t().getWeaponConfig()?.damage??0,getWeaponConfig:()=>{const{equippedWeapon:n}=h.getState();return n?$[n]??null:null},reset:()=>e({lastAttackTime:0,recentHits:[]})}))),ke=200;function xt(){const e=l.useRef(null),t=h(c=>c.equippedWeapon),n=J(c=>c.lastAttackTime),r=l.useRef(0);if(P(()=>{if(!e.current)return;const u=performance.now()-n;if(n!==r.current&&(r.current=n),u<ke){const f=u/ke,x=Math.sin(f*Math.PI)*1.5;e.current.rotation.x=-x}else e.current.rotation.x=0,e.current.rotation.z=Math.sin(performance.now()*.002)*.05-.3}),!t)return null;const s=t==="spiked_bat",i=s?"#666666":"#8B7355",a=s?1.2:1;return o.jsxs("group",{ref:e,position:[.5,.7,.3],rotation:[0,0,-.3],children:[o.jsxs("mesh",{castShadow:!0,children:[o.jsx("boxGeometry",{args:[.1,a,.1]}),o.jsx("meshToonMaterial",{color:i})]}),s&&o.jsxs(o.Fragment,{children:[o.jsxs("mesh",{position:[.08,.4,0],castShadow:!0,children:[o.jsx("coneGeometry",{args:[.04,.12,4]}),o.jsx("meshToonMaterial",{color:"#999999"})]}),o.jsxs("mesh",{position:[-.08,.35,0],castShadow:!0,children:[o.jsx("coneGeometry",{args:[.04,.12,4]}),o.jsx("meshToonMaterial",{color:"#999999"})]})]})]})}const gt="#FFD700",yt="#FFCC80",Re="#111111",U="#4488CC",wt=l.forwardRef(function(t,n){const r=l.useRef(null),s=l.useRef(null),i=l.useRef(null),a=l.useRef(null),c=l.useRef(null),u=Xe();Qe(r),l.useImperativeHandle(n,()=>r.current,[]);const f=l.useRef(Math.PI);return P((x,g)=>{if(!r.current)return;const p=et(u.current),w=p.x!==0||p.z!==0,m=r.current.position,_=m.x+p.x*ge*g,d=m.z+p.z*ge*g,b=Be(_,d,.3),v=tt(b.x,m.y,b.z);m.set(v.x,v.y,v.z);const j=nt(p);if(j!==null){let y=j-f.current;for(;y>Math.PI;)y-=Math.PI*2;for(;y<-Math.PI;)y+=Math.PI*2;f.current+=y*.35,r.current.rotation.y=f.current}if(w){const y=performance.now()*.01,M=Math.sin(y)*.15;s.current&&(s.current.rotation.x=M),i.current&&(i.current.rotation.x=-M),a.current&&(a.current.rotation.x=-M*.8),c.current&&(c.current.rotation.x=M*.8)}else s.current&&(s.current.rotation.x=0),i.current&&(i.current.rotation.x=0),a.current&&(a.current.rotation.x=0),c.current&&(c.current.rotation.x=0)}),o.jsxs("group",{ref:r,position:[0,0,0],rotation:[0,Math.PI,0],children:[o.jsxs("mesh",{position:[0,.9,0],castShadow:!0,children:[o.jsx("boxGeometry",{args:[.6,.8,.4]}),o.jsx("meshToonMaterial",{color:gt})]}),o.jsxs("mesh",{position:[0,1.65,0],castShadow:!0,children:[o.jsx("sphereGeometry",{args:[.35,12,8]}),o.jsx("meshToonMaterial",{color:yt})]}),o.jsxs("mesh",{position:[-.12,1.7,.3],children:[o.jsx("sphereGeometry",{args:[.06,8,6]}),o.jsx("meshBasicMaterial",{color:Re})]}),o.jsxs("mesh",{position:[.12,1.7,.3],children:[o.jsx("sphereGeometry",{args:[.06,8,6]}),o.jsx("meshBasicMaterial",{color:Re})]}),o.jsxs("mesh",{ref:a,position:[-.4,.9,0],castShadow:!0,children:[o.jsx("boxGeometry",{args:[.2,.6,.2]}),o.jsx("meshToonMaterial",{color:U})]}),o.jsxs("mesh",{ref:c,position:[.4,.9,0],castShadow:!0,children:[o.jsx("boxGeometry",{args:[.2,.6,.2]}),o.jsx("meshToonMaterial",{color:U})]}),o.jsx(xt,{}),o.jsxs("mesh",{ref:s,position:[-.15,.25,0],castShadow:!0,children:[o.jsx("boxGeometry",{args:[.2,.5,.25]}),o.jsx("meshToonMaterial",{color:U})]}),o.jsxs("mesh",{ref:i,position:[.15,.25,0],castShadow:!0,children:[o.jsx("boxGeometry",{args:[.2,.5,.25]}),o.jsx("meshToonMaterial",{color:U})]})]})});function bt(e,t,n,r,s=1.5){const i=t.x-e.x,a=t.z-e.z,c=Math.sqrt(i*i+a*a),u=Math.atan2(i,a);if(c<=s)return{x:e.x,z:e.z,rotation:u};const f=Math.min(n*r,c-s),x=i/c,g=a/c;return{x:e.x+x*f,z:e.z+g*f,rotation:u}}function Ce(e,t,n){const r=t.x-e.x,s=t.z-e.z;return r*r+s*s<=n*n}function jt(e,t,n,r){const s=1e3/t;return r-n>=s?{damage:e,attacked:!0}:{damage:0,attacked:!1}}const A=Me.zombie_green,ne=1.5;function _t({id:e,startPosition:t,playerRef:n,onDeath:r,onDamagePlayer:s}){const i=l.useRef(null),a=l.useRef(A.health),c=l.useRef(0),u=l.useRef(!1),f=l.useRef(0),x=l.useRef(null),g=l.useRef(null),p=l.useRef(null),w=l.useRef(null),m=l.useRef(null);P((b,v)=>{if(!i.current||!n.current||u.current)return;const j=n.current.position,y=i.current.position,M=bt({x:y.x,z:y.z},{x:j.x,z:j.z},A.speed,v,ne);if(y.x=M.x,y.z=M.z,i.current.rotation.y=M.rotation,!Ce({x:y.x,z:y.z},{x:j.x,z:j.z},ne)){const k=performance.now()*.008,W=Math.sin(k)*.2;x.current&&(x.current.rotation.x=W),g.current&&(g.current.rotation.x=-W)}else x.current&&(x.current.rotation.x=0),g.current&&(g.current.rotation.x=0);if(Ce({x:y.x,z:y.z},{x:j.x,z:j.z},ne)){const k=performance.now(),W=jt(A.damage,A.attackSpeed,c.current,k);W.attacked&&(c.current=k,s(W.damage))}if(f.current>0&&(f.current-=v*5,p.current)){const k=Math.max(0,f.current);p.current.emissive.setRGB(k,k,k)}if(w.current&&(w.current.rotation.y=-i.current.rotation.y),m.current){const k=Math.max(0,a.current/A.health);m.current.scale.x=k,m.current.position.x=-(1-k)*.5}});const _=b=>{if(!u.current&&(a.current-=b,f.current=1,a.current<=0)){u.current=!0;const v=i.current?.position;v&&r(e,[v.x,v.y,v.z])}},d=l.useRef({id:e,takeDamage:_,healthRef:a});return d.current={id:e,takeDamage:_,healthRef:a},u.current?null:o.jsxs("group",{ref:b=>{i.current=b,b&&(b.userData.zombieHandle=d.current)},position:t,children:[o.jsxs("mesh",{position:[0,.8,0],castShadow:!0,children:[o.jsx("boxGeometry",{args:[.8,1.2,.5]}),o.jsx("meshToonMaterial",{ref:p,color:A.color})]}),o.jsxs("mesh",{position:[0,1.8,0],castShadow:!0,children:[o.jsx("sphereGeometry",{args:[.4,10,8]}),o.jsx("meshToonMaterial",{color:A.color})]}),o.jsxs("mesh",{position:[-.15,1.85,.35],children:[o.jsx("sphereGeometry",{args:[.06,6,4]}),o.jsx("meshBasicMaterial",{color:"#FF0000"})]}),o.jsxs("mesh",{position:[.15,1.85,.35],children:[o.jsx("sphereGeometry",{args:[.06,6,4]}),o.jsx("meshBasicMaterial",{color:"#FF0000"})]}),o.jsxs("mesh",{position:[-.55,.9,.3],rotation:[-.8,0,0],castShadow:!0,children:[o.jsx("boxGeometry",{args:[.2,.6,.2]}),o.jsx("meshToonMaterial",{color:A.color})]}),o.jsxs("mesh",{position:[.55,.9,.3],rotation:[-.8,0,0],castShadow:!0,children:[o.jsx("boxGeometry",{args:[.2,.6,.2]}),o.jsx("meshToonMaterial",{color:A.color})]}),o.jsxs("mesh",{ref:x,position:[-.2,.15,0],castShadow:!0,children:[o.jsx("boxGeometry",{args:[.25,.4,.25]}),o.jsx("meshToonMaterial",{color:"#388E3C"})]}),o.jsxs("mesh",{ref:g,position:[.2,.15,0],castShadow:!0,children:[o.jsx("boxGeometry",{args:[.25,.4,.25]}),o.jsx("meshToonMaterial",{color:"#388E3C"})]}),o.jsxs("group",{ref:w,position:[0,2.4,0],children:[o.jsxs("mesh",{children:[o.jsx("planeGeometry",{args:[1,.12]}),o.jsx("meshBasicMaterial",{color:"#333333"})]}),o.jsxs("mesh",{ref:m,position:[0,0,.001],children:[o.jsx("planeGeometry",{args:[1,.12]}),o.jsx("meshBasicMaterial",{color:"#4CAF50"})]})]})]})}const vt=l.forwardRef(function({playerRef:t,onEnemyDeath:n},r){const[s,i]=l.useState([]),a=l.useRef(new Map),c=l.useRef(0),u=h(d=>d.setEnemiesAlive),f=h(d=>d.gameOver),x=h(d=>d.gameStarted);l.useEffect(()=>{!x&&!f&&(i([]),a.current.clear(),c.current=0,u(0))},[x,f,u]);const g=l.useCallback(d=>{const b=`zombie-${c.current++}`;i(v=>{const j=[...v,{id:b,position:d,alive:!0}];return u(j.filter(y=>y.alive).length),j})},[u]),p=l.useCallback(()=>{const d=[];for(const[b,v]of a.current){const j=v.children[0],y=j?.userData?.zombieHandle;y&&y.healthRef.current>0&&d.push({id:b,x:j.position.x,z:j.position.z,health:y.healthRef.current,takeDamage:y.takeDamage})}return d},[]);l.useImperativeHandle(r,()=>({spawnEnemy:g,getAliveEnemies:p}),[g,p]);const w=l.useCallback((d,b)=>{i(v=>{const j=v.map(y=>y.id===d?{...y,alive:!1}:y);return u(j.filter(y=>y.alive).length),j}),n(b)},[u,n]),m=l.useCallback(d=>{h.getState().takeDamage(d)},[]),_=l.useCallback((d,b)=>{},[]);return o.jsx("group",{children:s.filter(d=>d.alive).map(d=>o.jsx("group",{ref:b=>{b?a.current.set(d.id,b):a.current.delete(d.id)},children:o.jsx(_t,{id:d.id,startPosition:d.position,playerRef:t,onDeath:w,onDamagePlayer:m,onTakeDamage:_})},d.id))})});function St(e,t,n){return e.filter(r=>{if(r.health<=0)return!1;const s=r.x-t.x,i=r.z-t.z;return s*s+i*i<=n*n})}function kt(e,t,n){const r=n.x-e.x,s=n.z-e.z,i=Math.sin(t),a=Math.cos(t);return r*i+s*a>=-.001}function Rt({playerRef:e,enemyManagerRef:t,onHit:n}){const r=l.useRef(!1),s=l.useCallback(()=>{if(!e.current||!t.current)return;const i=J.getState();if(!i.canAttack())return;const a=i.getWeaponConfig();if(!a)return;const c=i.performAttack();if(c===0)return;const u=e.current.position,f=e.current.rotation.y,x=t.current.getAliveEnemies(),g=St(x.map(d=>({id:d.id,x:d.x,z:d.z,health:d.health})),{x:u.x,z:u.z},a.range),p=a.isRanged?g.filter(d=>kt({x:u.x,z:u.z},f,{x:d.x,z:d.z})):g;if(p.length===0)return;let w=p[0],m=1/0;for(const d of p){const b=d.x-u.x,v=d.z-u.z,j=b*b+v*v;j<m&&(m=j,w=d)}const _=x.find(d=>d.id===w.id);_&&(_.takeDamage(c),i.registerHit(w.id,c),n([w.x,1,w.z],c))},[e,t,n]);return l.useEffect(()=>{const i=u=>{u.code==="Space"&&(u.preventDefault(),r.current=!0)},a=u=>{u.code==="Space"&&(r.current=!1)},c=()=>{h.getState().gameStarted&&!h.getState().gameOver&&s()};return window.addEventListener("keydown",i),window.addEventListener("keyup",a),window.addEventListener("click",c),()=>{window.removeEventListener("keydown",i),window.removeEventListener("keyup",a),window.removeEventListener("click",c)}},[s]),P(()=>{if(!r.current)return;const{gameStarted:i,gameOver:a}=h.getState();!i||a||s()}),null}const ze=3,Ct=5;function zt({id:e,position:t,amount:n,onCollect:r,playerRef:s}){const i=l.useRef(null),a=l.useRef(!1);return P((c,u)=>{if(!i.current||!s.current||a.current)return;const f=i.current.position,x=s.current.position;i.current.rotation.y+=u*3,f.y=t[1]+.5+Math.sin(performance.now()*.003)*.2;const g=x.x-f.x,p=x.z-f.z,w=Math.sqrt(g*g+p*p);if(w<Ct&&w>ze){const m=4*u;f.x+=g/w*m,f.z+=p/w*m}w<ze&&(a.current=!0,r(e,n))}),o.jsxs("mesh",{ref:i,position:[t[0],t[1]+.5,t[2]],castShadow:!0,children:[o.jsx("cylinderGeometry",{args:[.3,.3,.08,12]}),o.jsx("meshToonMaterial",{color:"#FFD700",emissive:"#FFD700",emissiveIntensity:.3})]})}const z=fe()(pe((e,t)=>({coins:0,pendingCoinSpawns:[],addCoins:n=>e(r=>{r.coins+=n}),spendCoins:n=>t().coins<n?!1:(e(r=>{r.coins-=n}),!0),canAfford:n=>t().coins>=n,rollCoinDrop:n=>{const[r,s]=n;return Math.floor(Math.random()*(s-r+1))+r},buyWeapon:n=>{const r=$[n];if(!r)return!1;const s=h.getState();return s.ownedWeapons.includes(n)||!t().spendCoins(r.cost)?!1:(s.addWeapon(n),s.equipWeapon(n),!0)},queueCoinSpawn:n=>e(r=>{r.pendingCoinSpawns.push({position:n})}),drainCoinSpawns:()=>{const n=[...t().pendingCoinSpawns];return n.length>0&&e(r=>{r.pendingCoinSpawns=[]}),n},reset:()=>e({coins:0,pendingCoinSpawns:[]})})));function At({playerRef:e}){const[t,n]=l.useState([]),r=z(a=>a.addCoins),s=l.useRef(0);P(()=>{const a=z.getState().drainCoinSpawns();if(a.length===0)return;const c=Me.zombie_green,u=a.map(f=>({id:`coin-${s.current++}`,position:f.position,amount:z.getState().rollCoinDrop(c.coinDrop)}));n(f=>[...f,...u])});const i=l.useCallback((a,c)=>{r(c),n(u=>u.filter(f=>f.id!==a))},[r]);return o.jsx(o.Fragment,{children:t.map(a=>o.jsx(zt,{id:a.id,position:a.position,amount:a.amount,onCollect:i,playerRef:e},a.id))})}const re=[{waveNumber:1,enemies:[{type:"zombie_green",count:2,spawnDelay:3}],bonusCoins:50},{waveNumber:2,enemies:[{type:"zombie_green",count:3,spawnDelay:2.5}],bonusCoins:100},{waveNumber:3,enemies:[{type:"zombie_green",count:4,spawnDelay:2}],bonusCoins:150},{waveNumber:4,enemies:[{type:"zombie_green",count:5,spawnDelay:2}],bonusCoins:200},{waveNumber:5,enemies:[{type:"zombie_green",count:8,spawnDelay:1.5}],bonusCoins:300}];function Mt({enemyManagerRef:e}){const t=l.useRef("idle"),n=l.useRef(0),r=l.useRef(0),s=l.useRef(0),i=l.useRef(-1),a=h(m=>m.wave),c=h(m=>m.gameStarted),u=h(m=>m.gameOver),f=h(m=>m.enemiesAlive),x=h(m=>m.nextWave),g=z(m=>m.addCoins),p=l.useCallback(m=>{t.current=m;const _=h.getState();m==="spawning"?(_.setAnnouncement(`Wave ${_.wave}`),setTimeout(()=>h.getState().setAnnouncement(""),2e3)):m==="waveComplete"?(_.setAnnouncement(`Wave ${_.wave} Complete!`),setTimeout(()=>h.getState().setAnnouncement(""),2e3)):m==="allComplete"&&_.setVictory(!0)},[]);l.useEffect(()=>{!c&&!u&&(t.current="idle",i.current=-1,r.current=0,n.current=0,s.current=0)},[c,u]),l.useEffect(()=>{c&&t.current==="idle"&&a===1&&(i.current=0,r.current=0,n.current=0,p("spawning"))},[c,a,p]);const w=l.useCallback(()=>{const m=Math.random()*Math.PI*2,_=C.clearRadius+5;return[Math.cos(m)*_,0,Math.sin(m)*_]},[]);return P((m,_)=>{if(!c||u)return;const d=t.current,b=i.current;if(b<0||b>=re.length)return;const v=re[b],j=v.enemies[0];d==="spawning"&&(n.current+=_,n.current>=j.spawnDelay&&r.current<j.count&&(n.current=0,r.current++,e.current&&e.current.spawnEnemy(w()),r.current>=j.count&&p("active"))),d==="active"&&f===0&&r.current>0&&(g(v.bonusCoins),p("waveComplete"),s.current=0),d==="waveComplete"&&(s.current+=_,s.current>=2&&(b+1>=re.length?p("allComplete"):(p("interWave"),s.current=0))),d==="interWave"&&(s.current+=_,s.current>=3&&(i.current++,r.current=0,n.current=0,x(),p("spawning")))}),null}function Pt(e,t){const n=e/t*100;return n>50?"#4CAF50":n>=25?"#FFC107":"#F44336"}function Et(e,t){return`${Math.max(0,Math.min(100,e/t*100))}%`}function Nt(e,t){return t?e===0?"Get Ready!":`Wave ${e}`:""}function Dt(){const e=h(n=>n.playerHealth),t=h(n=>n.playerMaxHealth);return o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("span",{className:"text-xs font-bold text-white drop-shadow",children:"HP"}),o.jsx("div",{className:"w-32 h-4 bg-black/50 rounded-full overflow-hidden border border-white/20",children:o.jsx("div",{className:"h-full rounded-full transition-all duration-300",style:{width:Et(e,t),backgroundColor:Pt(e,t)}})}),o.jsxs("span",{className:"text-xs font-bold text-white drop-shadow",children:[e,"/",t]})]})}function Ot(){const e=z(t=>t.coins);return o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsx("span",{className:"text-yellow-400 text-lg",children:"â—"}),o.jsx("span",{className:"text-yellow-300 font-bold text-lg drop-shadow",children:e})]})}function Ft(){const e=h(r=>r.wave),t=h(r=>r.gameStarted),n=Nt(e,t);return n?o.jsx("div",{className:"text-white font-bold text-lg drop-shadow text-center",children:n}):null}function Wt(){const e=h(n=>n.equippedWeapon),t=e?$[e]?.type.replace("_"," ")??"":"None";return o.jsxs("div",{className:"fixed inset-x-0 top-0 p-3 pointer-events-none z-10",children:[o.jsxs("div",{className:"flex justify-between items-start",children:[o.jsx("div",{className:"bg-black/30 backdrop-blur-sm rounded-lg px-3 py-2",children:o.jsx(Dt,{})}),o.jsx("div",{className:"bg-black/30 backdrop-blur-sm rounded-lg px-4 py-2",children:o.jsx(Ft,{})}),o.jsx("div",{className:"bg-black/30 backdrop-blur-sm rounded-lg px-3 py-2",children:o.jsx(Ot,{})})]}),o.jsxs("div",{className:"fixed bottom-3 left-3 bg-black/30 backdrop-blur-sm rounded-lg px-3 py-2",children:[o.jsx("span",{className:"text-white/70 text-xs",children:"Weapon: "}),o.jsx("span",{className:"text-white font-bold text-sm capitalize",children:t})]})]})}function Tt(){const e=h(a=>a.ownedWeapons),t=h(a=>a.gameStarted),n=h(a=>a.addWeapon),r=h(a=>a.equipWeapon),s=h(a=>a.startGame);if(e.length>0||t)return null;const i=()=>{n("bat"),r("bat"),s()};return o.jsx("div",{className:"fixed inset-0 flex items-end justify-center pb-24 pointer-events-none z-20",children:o.jsx("button",{onClick:i,className:`pointer-events-auto animate-bounce bg-gradient-to-b from-yellow-400 to-orange-500
          text-white font-bold text-2xl px-8 py-4 rounded-2xl shadow-lg shadow-orange-500/50
          hover:from-yellow-300 hover:to-orange-400 hover:scale-105
          active:scale-95 transition-all duration-150
          border-2 border-yellow-300/50`,children:"Pick Up Bat - FREE!"})})}function It(){const[e,t]=l.useState(!1),n=z(u=>u.coins),r=z(u=>u.buyWeapon),s=h(u=>u.ownedWeapons),i=$.spiked_bat,a=s.includes("spiked_bat"),c=n>=i.cost;return o.jsxs(o.Fragment,{children:[o.jsx("button",{onClick:()=>t(!e),className:`fixed bottom-3 right-3 z-20 bg-purple-600 hover:bg-purple-500
          text-white font-bold px-4 py-2 rounded-lg shadow-lg
          transition-colors duration-150`,children:e?"Close":"Shop"}),e&&o.jsxs("div",{className:`fixed bottom-16 right-3 z-20 bg-black/80 backdrop-blur-sm
          rounded-xl p-4 w-64 border border-white/10`,children:[o.jsx("h2",{className:"text-white font-bold text-lg mb-3",children:"Shop"}),o.jsxs("div",{className:"bg-white/10 rounded-lg p-3",children:[o.jsxs("div",{className:"flex justify-between items-center mb-2",children:[o.jsx("span",{className:"text-white font-bold",children:"Spiked Bat"}),o.jsxs("span",{className:"text-yellow-400 font-bold",children:[i.cost," coins"]})]}),o.jsxs("p",{className:"text-white/60 text-sm mb-3",children:["Double the damage! ",i.damage," dmg"]}),o.jsx("button",{onClick:()=>r("spiked_bat"),disabled:a||!c,className:`w-full py-2 rounded-lg font-bold text-white transition-colors ${a?"bg-gray-600 cursor-not-allowed":c?"bg-green-600 hover:bg-green-500 active:bg-green-700":"bg-gray-600 cursor-not-allowed opacity-50"}`,children:a?"OWNED":c?"BUY":"Not enough coins"})]})]})]})}function Gt(){return o.jsxs("div",{className:"fixed inset-0 flex flex-col items-center justify-start pt-16 pointer-events-none z-10",children:[o.jsx("h1",{className:"text-yellow-400 text-5xl font-bold drop-shadow-lg mb-2",children:"Creature Defense Tycoon"}),o.jsx("p",{className:"text-white/80 text-xl drop-shadow",children:"Pick up the bat to start!"})]})}function Lt(){const e=h(i=>i.resetGame),t=z(i=>i.reset),n=J(i=>i.reset),r=h(i=>i.wave),s=()=>{e(),t(),n()};return o.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-40",children:o.jsxs("div",{className:"text-center",children:[o.jsx("h1",{className:"text-red-500 text-6xl font-bold mb-4 drop-shadow-lg",children:"GAME OVER"}),o.jsxs("p",{className:"text-white/80 text-xl mb-2",children:["You made it to Wave ",r]}),o.jsx("button",{onClick:s,className:`mt-6 bg-gradient-to-b from-red-500 to-red-700 text-white
            font-bold text-xl px-8 py-3 rounded-xl shadow-lg
            hover:from-red-400 hover:to-red-600 active:scale-95
            transition-all duration-150`,children:"Try Again"})]})})}function Ht(){const e=z(i=>i.coins),t=h(i=>i.resetGame),n=z(i=>i.reset),r=J(i=>i.reset),s=()=>{t(),n(),r()};return o.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-40",children:o.jsxs("div",{className:"text-center",children:[o.jsx("h1",{className:"text-yellow-400 text-6xl font-bold mb-4 drop-shadow-lg",children:"YOU WIN!"}),o.jsx("p",{className:"text-white/80 text-xl mb-1",children:"All waves defeated!"}),o.jsxs("p",{className:"text-yellow-300 text-lg mb-6",children:["Final coins: ",e]}),o.jsx("p",{className:"text-white/50 text-sm mb-8 italic",children:"More phases coming soon... Full Moon awaits!"}),o.jsx("button",{onClick:s,className:`bg-gradient-to-b from-yellow-400 to-orange-500 text-white
            font-bold text-xl px-8 py-3 rounded-xl shadow-lg
            hover:from-yellow-300 hover:to-orange-400 active:scale-95
            transition-all duration-150`,children:"Play Again"})]})})}function Bt({text:e}){return e?o.jsx("div",{className:"fixed inset-0 flex items-center justify-center pointer-events-none z-30",children:o.jsx("div",{className:"text-white text-5xl font-bold drop-shadow-lg animate-pulse",children:e})}):null}function Ut(){const e=l.useRef(null),t=l.useRef(null),n=l.useCallback(s=>{z.getState().queueCoinSpawn(s)},[]),r=l.useCallback((s,i)=>{},[]);return o.jsxs(o.Fragment,{children:[o.jsx(Ze,{}),o.jsx(wt,{ref:e}),o.jsx(vt,{ref:t,playerRef:e,onEnemyDeath:n}),o.jsx(Rt,{playerRef:e,enemyManagerRef:t,onHit:r}),o.jsx(At,{playerRef:e}),o.jsx(Mt,{enemyManagerRef:t})]})}function Kt(){const e=h(s=>s.gameStarted),t=h(s=>s.gameOver),n=h(s=>s.isVictory),r=h(s=>s.announcement);return o.jsxs(o.Fragment,{children:[o.jsx(Te,{camera:{position:[0,8,12],fov:60},shadows:!0,children:o.jsx(l.Suspense,{fallback:null,children:o.jsx(Ut,{})})}),!e&&o.jsx(Gt,{}),!e&&o.jsx(Tt,{}),e&&!t&&!n&&o.jsx(Wt,{}),e&&!t&&!n&&o.jsx(It,{}),t&&!n&&o.jsx(Lt,{}),n&&o.jsx(Ht,{}),r&&o.jsx(Bt,{text:r})]})}Ie.createRoot(document.getElementById("root")).render(o.jsx(Ge.StrictMode,{children:o.jsx(Kt,{})}));
